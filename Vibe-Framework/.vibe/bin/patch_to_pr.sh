#!/bin/bash
# patch_to_pr.sh - Applique les patchs comme branches locales et cr√©e PR si possible
VIBE_ROOT="$(cd "$(dirname "${BASH_SOURCE[0]}")/../.." && pwd)"
PATCH_DIR="$VIBE_ROOT/.vibe/patches"
WORKTREE_BASE="$VIBE_ROOT/.vibe/patch_worktrees"
mkdir -p "$PATCH_DIR" "$WORKTREE_BASE"

if ! git rev-parse --is-inside-work-tree >/dev/null 2>&1; then
    echo "‚ùå Not a git repo. Aborting."
    exit 1
fi

for patch in "$PATCH_DIR"/*.patch "$PATCH_DIR"/*.diff; do
    [ -e "$patch" ] || continue
    name=$(basename "$patch")
    branch="vibe/patch/$(date +%s)_${name//[^a-zA-Z0-9]/_}"
    echo "üîÅ Processing $name -> branch $branch"

    # Create a worktree for applying the patch
    WT=$(mktemp -d "$WORKTREE_BASE/wt_XXXX")
    git worktree add "$WT" HEAD >/dev/null 2>&1 || { echo "‚ö†Ô∏è worktree add failed"; rm -rf "$WT" ; continue; }

    # Try applying the patch
    if git -C "$WT" apply --index "$patch" 2>/dev/null; then
        git -C "$WT" checkout -b "$branch"
        git -C "$WT" commit -am "Apply Vibe patch $name" --no-verify >/dev/null 2>&1 || true
        echo "‚úÖ Branch created: $branch (worktree: $WT)"
        # Push branch if remote present and user wants
        if git remote >/dev/null 2>&1; then
            if command -v gh >/dev/null 2>&1; then
                git -C "$WT" push -u origin "$branch" >/dev/null 2>&1 || echo "‚ö†Ô∏è Push failed"
                gh pr create --fill --title "Vibe patch: $name" --body "Patch generated by Vibe" >/dev/null 2>&1 || echo "‚ö†Ô∏è gh pr create failed or not authenticated"
            else
                echo "‚ÑπÔ∏è gh CLI not found ‚Äî branch created locally. Push manually: git push origin $branch"
            fi
        else
            echo "‚ÑπÔ∏è No git remote configured ‚Äî branch created locally"
        fi
    else
        echo "‚ùå Failed to apply patch $name"
    fi

done

echo "Done. Review branches and PRs."
